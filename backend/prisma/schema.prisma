// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Clinic {
  id                String   @id @default(uuid())
  name              String
  domain            String   @unique
  licenseKey        String?  @unique @map("license_key")
  licenseExpiresAt  DateTime? @map("license_expires_at")
  settings          Json?
  createdAt         DateTime @default(now()) @map("created_at")
  
  users             User[]
  patients          Patient[]
  acronyms          AcronymDictionary[]
  performance       ClinicPerformance[]
  
  @@map("clinics")
}

model User {
  id              String   @id @default(uuid())
  clinicId        String   @map("clinic_id")
  username        String
  passwordHash    String   @map("password_hash")
  role            String
  assignedToName  String?  @map("assigned_to_name")
  assignedToEmail String?  @map("assigned_to_email")
  assignedDate    DateTime? @map("assigned_date")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  
  clinic          Clinic   @relation(fields: [clinicId], references: [id])
  
  timelineEventsCreated TimelineEvent[] @relation("EventCreator")
  actionsAssigned       ActionQueue[] @relation("ActionAssignee")
  actionsCompleted      ActionQueue[] @relation("ActionCompleter")
  
  @@unique([clinicId, username])
  @@map("users")
}

model Patient {
  id                  String   @id @default(uuid())
  clinicId            String   @map("clinic_id")
  mrNumber            String   @unique @map("mr_number")
  firstName           String?  @map("first_name")
  lastName            String?  @map("last_name")
  age                 Int?
  phone               String?
  email               String?
  amh                 Float?
  bmi                 Float?
  previousCycles      Int      @default(0) @map("previous_cycles")
  preferredLanguage   String   @default("hindi_english") @map("preferred_language")
  detailPreference    String   @default("high") @map("detail_preference")
  visualLearner       Boolean  @default(false) @map("visual_learner")
  baselineAnxiety     Int      @default(5) @map("baseline_anxiety")
  currentAnxiety      Int      @default(5) @map("current_anxiety")
  anxietyTriggers     String[] @map("anxiety_triggers")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  
  clinic              Clinic   @relation(fields: [clinicId], references: [id])
  
  cycles              TreatmentCycle[]
  timelineEvents      TimelineEvent[]
  actions             ActionQueue[]
  
  @@map("patients")
}

model TreatmentCycle {
  id                    String   @id @default(uuid())
  patientId             String   @map("patient_id")
  cycleNumber           Int      @map("cycle_number")
  protocol              String?
  startDate             DateTime? @map("start_date")
  expectedRetrievalDate DateTime? @map("expected_retrieval_date")
  status                String   @default("active")
  currentPhase          String?  @map("current_phase")
  cycleDay              Int?     @map("cycle_day")
  outcome               String?
  outcomeDate           DateTime? @map("outcome_date")
  createdAt             DateTime @default(now()) @map("created_at")
  
  patient               Patient  @relation(fields: [patientId], references: [id])
  timelineEvents        TimelineEvent[]
  
  @@map("treatment_cycles")
}

model TimelineEvent {
  id                  String   @id @default(uuid())
  patientId           String   @map("patient_id")
  cycleId             String?  @map("cycle_id")
  eventType           String   @map("event_type")
  eventDate           DateTime @default(now()) @map("event_date")
  cycleDay            Int?     @map("cycle_day")
  createdBy           String   @map("created_by")
  staffRole           String   @map("staff_role")
  clinicalData        Json?    @map("clinical_data")
  communicationData   Json?    @map("communication_data")
  reactionData        Json?    @map("reaction_data")
  counselingData      Json?    @map("counseling_data")
  summaryText         String?  @map("summary_text")
  patientRecordText   String?  @map("patient_record_text")
  searchableText      String?  @map("searchable_text")
  createdAt           DateTime @default(now()) @map("created_at")
  
  patient             Patient  @relation(fields: [patientId], references: [id])
  cycle               TreatmentCycle? @relation(fields: [cycleId], references: [id])
  creator             User     @relation("EventCreator", fields: [createdBy], references: [id])
  
  actions             ActionQueue[]
  
  @@index([patientId, eventDate(sort: Desc)])
  @@index([cycleId, eventDate(sort: Desc)])
  @@map("timeline_events")
}

model Template {
  id                    String   @id @default(uuid())
  name                  String
  eventType             String   @map("event_type")
  category              String
  language              String
  content               String
  triggerConditions     Json?    @map("trigger_conditions")
  suggestedVisuals      String[] @map("suggested_visuals")
  talkingPoints         String[] @map("talking_points")
  timesUsed             Int      @default(0) @map("times_used")
  avgAnxietyReduction   Float?   @map("avg_anxiety_reduction")
  avgResponseTimeMinutes Int?    @map("avg_response_time_minutes")
  isActive              Boolean  @default(true) @map("is_active")
  createdAt             DateTime @default(now()) @map("created_at")
  
  actions               ActionQueue[]
  
  @@map("templates")
}

model VisualAsset {
  id                  String   @id @default(uuid())
  name                String
  category            String
  description         String?
  fileUrl             String   @map("file_url")
  thumbnailUrl        String?  @map("thumbnail_url")
  fileType            String   @map("file_type")
  fileSizeKb          Int      @map("file_size_kb")
  languages           String[]
  timesUsed           Int      @default(0) @map("times_used")
  effectivenessScore  Float?   @map("effectiveness_score")
  suggestedForEvents  String[] @map("suggested_for_events")
  createdAt           DateTime @default(now()) @map("created_at")
  
  @@map("visual_assets")
}

model AcronymDictionary {
  id              String   @id @default(uuid())
  clinicId        String?  @map("clinic_id")
  acronym         String   @unique
  expansion       String
  category        String
  unit            String?
  normalRangeMin  Float?   @map("normal_range_min")
  normalRangeMax  Float?   @map("normal_range_max")
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  
  clinic          Clinic?  @relation(fields: [clinicId], references: [id])
  
  @@map("acronym_dictionary")
}

model ClinicPerformance {
  id                          String   @id @default(uuid())
  clinicId                    String   @map("clinic_id")
  date                        DateTime
  activePatients              Int      @map("active_patients")
  newPatients                 Int      @map("new_patients")
  cyclesStarted               Int      @map("cycles_started")
  cyclesCompleted             Int      @map("cycles_completed")
  eggRetrievals               Int      @map("egg_retrievals")
  avgEggsRetrieved            Float?   @map("avg_eggs_retrieved")
  transfers                   Int
  positiveBetas               Int      @map("positive_betas")
  messagesSent                Int      @map("messages_sent")
  patientResponses            Int      @map("patient_responses")
  avgResponseTimeMinutes      Int?     @map("avg_response_time_minutes")
  avgAnxietyReduction         Float?   @map("avg_anxiety_reduction")
  documentationCompletionRate Float?   @map("documentation_completion_rate")
  visualUsageRate             Float?   @map("visual_usage_rate")
  staffEntries                Json?    @map("staff_entries")
  createdAt                   DateTime @default(now()) @map("created_at")
  
  clinic                      Clinic   @relation(fields: [clinicId], references: [id])
  
  @@unique([clinicId, date])
  @@map("clinic_performance")
}

model ActionQueue {
  id              String   @id @default(uuid())
  patientId       String   @map("patient_id")
  actionType      String   @map("action_type")
  priority        String
  eventId         String?  @map("event_id")
  templateId      String?  @map("template_id")
  suggestedVisuals String[] @map("suggested_visuals")
  dueAt           DateTime @map("due_at")
  assignedTo      String?  @map("assigned_to")
  status          String   @default("pending")
  completedAt     DateTime? @map("completed_at")
  completedBy     String?  @map("completed_by")
  createdAt       DateTime @default(now()) @map("created_at")
  
  patient         Patient  @relation(fields: [patientId], references: [id])
  event           TimelineEvent? @relation(fields: [eventId], references: [id])
  template        Template? @relation(fields: [templateId], references: [id])
  assignee        User?    @relation("ActionAssignee", fields: [assignedTo], references: [id])
  completer       User?    @relation("ActionCompleter", fields: [completedBy], references: [id])
  
  @@index([status, dueAt])
  @@map("action_queue")
}
